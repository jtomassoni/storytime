// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
}

enum StoryObjectionReason {
  TOO_SCARY
  NOT_AGE_APPROPRIATE
  CULTURAL_MISMATCH
  LANGUAGE_ISSUE
  OTHER
}

model User {
  id             String           @id @default(cuid())
  email          String           @unique
  name           String?
  hashedPassword String?
  role           UserRole         @default(USER)
  isPaid         Boolean          @default(false)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  children       ChildProfile[]
  favorites      FavoriteStory[]
  objections     StoryObjection[]
  readEvents     StoryReadEvent[]
  preferences    UserPreferences?

  @@map("users")
}

model ChildProfile {
  id        String   @id @default(cuid())
  userId    String
  name      String?
  birthdate DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("child_profiles")
}

model UserPreferences {
  id               String   @id @default(cuid())
  userId           String   @unique
  cultureRegion    String?
  preferredValues  String[] @default([])
  avoidTopics      String[] @default([])
  languagePrefs    String[] @default([])
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

model Category {
  id          String   @id @default(cuid())
  name        String
  description String?
  minAge      Int?
  maxAge      Int?
  cultureTags String[] @default([])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  stories     StoryCategory[]

  @@map("categories")
}

model Story {
  id                        String   @id @default(cuid())
  title                     String
  shortDescription          String
  longDescription           String?
  fullText                  String   // full story
  minAge                    Int?
  maxAge                    Int?
  estimatedReadTimeMinutes  Int?
  isActive                  Boolean  @default(true)

  // Metadata derived externally and entered manually:
  valuesTags                String[] @default([]) // e.g. ["kindness", "courage"]
  topicTags                 String[] @default([]) // e.g. ["bedtime", "forest"]
  cultureTags               String[] @default([]) // e.g. ["European", "Global"]
  languageTags              String[] @default([]) // e.g. ["en"]
  contentWarnings           String[] @default([]) // e.g. ["mild_scary"]
  representationTags        String[] @default([]) // e.g. ["girl protagonist", "mixed-race family"]

  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  categories                StoryCategory[]
  favorites                 FavoriteStory[]
  objections                StoryObjection[]
  readEvents                StoryReadEvent[]
  storyOfTheDayEntries      StoryOfTheDay[]

  @@map("stories")
}

model StoryCategory {
  storyId    String
  categoryId String

  story      Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([storyId, categoryId])
  @@map("story_categories")
}

model StoryOfTheDay {
  id        String   @id @default(cuid())
  date      DateTime @unique
  storyId   String

  story     Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@map("story_of_the_day")
}

model FavoriteStory {
  id        String   @id @default(cuid())
  userId    String
  storyId   String
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  story     Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@unique([userId, storyId])
  @@map("favorite_stories")
}

model StoryObjection {
  id            String               @id @default(cuid())
  userId        String
  storyId       String
  sentenceIndex Int?
  textSpan      String?
  reason        StoryObjectionReason
  comment       String?
  createdAt     DateTime             @default(now())

  user          User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  story         Story                @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@map("story_objections")
}

model StoryReadEvent {
  id          String   @id @default(cuid())
  userId      String?
  storyId     String
  startedAt   DateTime @default(now())
  completedAt DateTime?
  deviceType  String?

  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  story       Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@map("story_read_events")
}

